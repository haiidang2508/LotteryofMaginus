<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L·ªãch S·ª≠ Mua V√© S·ªë</title>
  <link rel="stylesheet" href="database-style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìù L·ªãch S·ª≠ Mua V√© S·ªë</h1>
      <a href="index.html" class="btn-back">‚Üê Quay L·∫°i Trang Ch√≠nh</a>
    </div>

    <div class="controls">
      <button class="btn-export" onclick="exportData()">üì• Xu·∫•t D·ªØ Li·ªáu (CSV)</button>
      <button class="btn-sync" onclick="syncToDatabase()">üíæ L∆∞u V√†o Database</button>
      <button class="btn-clear" onclick="clearHistory()">üóëÔ∏è X√≥a L·ªãch S·ª≠</button>
    </div>

    <div class="stats">
      <div class="stat-item">
        <span class="stat-label">T·ªïng S·ªë V√© B√°n:</span>
        <span class="stat-value" id="totalTickets">0</span>
      </div>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>S·ªë V√©</th>
            <th>T√™n Ng∆∞·ªùi Mua</th>
            <th>Th·ªùi Gian Mua</th>
            <th>H√†nh ƒê·ªông</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr class="empty-row">
            <td colspan="5">Ch∆∞a c√≥ l·ªãch s·ª≠ mua v√©</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // H√†m t·∫£i d·ªØ li·ªáu t·ª´ localStorage
    function loadHistory() {
      const tableBody = document.getElementById('tableBody');
      const buyersData = JSON.parse(localStorage.getItem('buyers')) || [];
      
      if (buyersData.length === 0) {
        tableBody.innerHTML = '<tr class="empty-row"><td colspan="5">Ch∆∞a c√≥ l·ªãch s·ª≠ mua v√©</td></tr>';
        document.getElementById('totalTickets').textContent = '0';
        return;
      }

      tableBody.innerHTML = '';
      buyersData.forEach((buyer, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td><strong>${buyer.ticketNumber}</strong></td>
          <td>${buyer.name}</td>
          <td>${new Date(buyer.date).toLocaleString('vi-VN')}</td>
          <td>
            <button class="btn-delete" onclick="deleteRecord(${index})">X√≥a</button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      document.getElementById('totalTickets').textContent = buyersData.length;
    }

    // H√†m x√≥a m·ªôt b·∫£n ghi
    function deleteRecord(index) {
      if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?')) {
        const buyersData = JSON.parse(localStorage.getItem('buyers')) || [];
        buyersData.splice(index, 1);
        localStorage.setItem('buyers', JSON.stringify(buyersData));
        loadHistory();
        alert('X√≥a th√†nh c√¥ng!');
      }
    }

    // H√†m x√≥a t·∫•t c·∫£ l·ªãch s·ª≠
    function clearHistory() {
      if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ l·ªãch s·ª≠?\n‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        localStorage.removeItem('buyers');
        loadHistory();
        alert('ƒê√£ x√≥a t·∫•t c·∫£ l·ªãch s·ª≠!');
      }
    }

    // H√†m xu·∫•t d·ªØ li·ªáu ra CSV
    function exportData() {
      const buyersData = JSON.parse(localStorage.getItem('buyers')) || [];
      
      if (buyersData.length === 0) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }

      let csv = 'STT,S·ªë V√©,T√™n Ng∆∞·ªùi Mua,Th·ªùi Gian Mua\n';
      buyersData.forEach((buyer, index) => {
        csv += `"${index + 1}","${buyer.ticketNumber}","${buyer.name}","${new Date(buyer.date).toLocaleString('vi-VN')}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', `lichsu_muave_${new Date().getTime()}.csv`);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert('Xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!');
    }

    // H√†m l∆∞u d·ªØ li·ªáu v√†o database (g·ª≠i l√™n server)
    function syncToDatabase() {
      const buyersData = JSON.parse(localStorage.getItem('buyers')) || [];
      
      if (buyersData.length === 0) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!');
        return;
      }

      // G·ª≠i d·ªØ li·ªáu l√™n server
      fetch('/api/save-purchases', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(buyersData)
      })
      .then(response => {
        if (response.ok) {
          alert('ƒê√£ l∆∞u v√†o database th√†nh c√¥ng!');
        } else {
          alert('L·ªói: Kh√¥ng th·ªÉ l∆∞u v√†o database. Vui l√≤ng ki·ªÉm tra server.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('L·ªói k·∫øt n·ªëi: ' + error.message);
      });
    }

    // Load d·ªØ li·ªáu khi trang t·∫£i
    document.addEventListener('DOMContentLoaded', loadHistory);

    // Refresh d·ªØ li·ªáu m·ªói 3 gi√¢y
    setInterval(loadHistory, 3000);
  </script>
</body>
</html>
